<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Crypto Hub ‚Äî Portfolio</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="assets/css/core.css">
<link rel="stylesheet" href="assets/css/sidebar.css">
<link rel="stylesheet" href="assets/css/topbar.css">
<link rel="stylesheet" href="assets/css/portfolio.css">
</head>

<body>
<div class="app">

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="logo">‚Çø Crypto Hub</div>
    <nav>
      <a href="index.html" class="nav-item active">üíº Portfolio</a>
      <a href="dashboard.html" class="nav-item">üè† Dashboard</a>
      <span class="nav-item disabled">üîî Signals</span>
      <span class="nav-item disabled">üìä Analytics</span>
    </nav>
  </aside>

  <!-- MAIN -->
  <main class="main">

    <!-- TOPBAR -->
    <header class="topbar">
      <div class="topbar-title">Portfolio</div>
    </header>

    <!-- CONTENT -->
    <section class="content">

      <!-- WHITE EXCEL SHEET -->
      <div class="portfolio-sheet">

<div class="excel-container">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
        <div class="portfolio-header">
            üìä CRYPTO PORTFOLIO MANAGER - Risk Management Tool
        </div>

        <!-- Toolbar -->
        <div class="toolbar">
            <button class="toolbar-btn" onclick="updateAllPrices()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Ü–µ–Ω—ã</button>
            <button class="toolbar-btn" onclick="addNewRow()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –º–æ–Ω–µ—Ç—É</button>
            <div class="toolbar-separator"></div>
            <button class="toolbar-btn" onclick="savePortfolio()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button class="toolbar-btn" onclick="exportToJSON()">üì§ –≠–∫—Å–ø–æ—Ä—Ç</button>
            <button class="toolbar-btn" onclick="importFromJSON()">üì• –ò–º–ø–æ—Ä—Ç</button>
            <div class="toolbar-separator"></div>
            <button class="toolbar-btn" onclick="showHistory()">üìú –ò—Å—Ç–æ—Ä–∏—è</button>
            <button class="toolbar-btn" onclick="showSettings()">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
            <div class="toolbar-separator"></div>
            <label style="font-size: 11px; display: flex; align-items: center; gap: 5px;">
                <input type="checkbox" id="autoUpdate" onchange="toggleAutoUpdate()">
                –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ (5 –º–∏–Ω)
            </label>
            <span id="lastUpdate" style="margin-left: 15px; font-size: 11px; color: #666;"></span>
        </div>

        <!-- –°–≤–æ–¥–∫–∞ -->
        <div class="summary-section">
            <div class="summary-grid">
                <div class="summary-item">
                    <div class="summary-label">–î–µ–ø–æ–∑–∏—Ç</div>
                    <div class="summary-value" id="totalDeposit">$10,000</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">–í–ª–æ–∂–µ–Ω–æ</div>
                    <div class="summary-value" id="totalInvested">$0</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">–¢–µ–∫—É—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å</div>
                    <div class="summary-value" id="currentValue">$0</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ</div>
                    <div class="summary-value positive" id="realizedPnl">$0</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">–ù–µ—Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ</div>
                    <div class="summary-value" id="unrealizedPnl">$0</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">–û–±—â–∞—è P&L</div>
                    <div class="summary-value" id="totalPnl">$0</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">ROI</div>
                    <div class="summary-value" id="roi">0%</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">–†–∏—Å–∫ –ø–æ—Ä—Ç—Ñ–µ–ª—è</div>
                    <div class="summary-value" id="portfolioRisk">0%</div>
                </div>
            </div>
        </div>

        <!-- –¢–∞–±–ª–∏—Ü–∞ -->
        <div class="worksheet">
            <table id="portfolioTable">
                <thead>
                    <tr>
                        <th style="width: 40px;">#</th>
                        <th style="width: 80px;">–ú–æ–Ω–µ—Ç–∞</th>
                        <th style="width: 100px;">–ò—Å—Ç–æ—á–Ω–∏–∫</th>
                        <th style="width: 60px;">Score</th>
                        <th style="width: 90px;">–î–∞—Ç–∞ –≤—Ö–æ–¥–∞</th>
                        <th style="width: 90px;">–¶–µ–Ω–∞ –≤—Ö–æ–¥–∞</th>
                        <th style="width: 90px;">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                        <th style="width: 90px;">–í–ª–æ–∂–µ–Ω–æ $</th>
                        <th style="width: 90px;">–¶–µ–Ω–∞ —Å–µ–π—á–∞—Å</th>
                        <th style="width: 90px;">–°—Ç–æ–∏–º–æ—Å—Ç—å $</th>
                        <th style="width: 70px;">P&L %</th>
                        <th style="width: 90px;">P&L $</th>
                        <th style="width: 90px;">–°—Ç–æ–ø $</th>
                        <th style="width: 70px;">–†–∏—Å–∫ %</th>
                        <th style="width: 150px;">–î–æ —É—Ä–æ–≤–Ω–µ–π</th>
                        <th style="width: 120px;">–î–µ–π—Å—Ç–≤–∏—è</th>
                        <th style="width: 40px;">‚ÑπÔ∏è</th>
                        <th style="width: 40px;">üóëÔ∏è</th>
                    </tr>
                </thead>
                <tbody id="portfolioBody">
                    <!-- –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è JS -->
                </tbody>
            </table>
        </div>

        <!-- Status Bar -->
        <div class="status-bar">
            <span>–ì–æ—Ç–æ–≤–æ | –ú–æ–Ω–µ—Ç: <span id="coinCount">0</span></span>
            <span>–°—Ä–µ–¥–Ω–∏–π ROI: <span id="avgROI">0%</span></span>
            <span id="updateStatus">–ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: –≤—ã–∫–ª</span>
        </div>
    </div>

    <!-- Modal: Sell -->
    <div id="sellModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span>–ü—Ä–æ–¥–∞–∂–∞: <span id="sellCoinName"></span></span>
                <span class="modal-close" onclick="closeSellModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-row">
                    <label>–¶–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏ ($)</label>
                    <input type="number" id="sellPrice" step="0.0001">
                </div>
                <div class="form-row">
                    <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
                    <input type="number" id="sellQty" step="1">
                </div>
                <div class="form-row">
                    <label>–ë—ã—Å—Ç—Ä—ã–π –≤—ã–±–æ—Ä</label>
                    <select onchange="quickSell(this.value)">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ</option>
                        <option value="20">20% (–£—Ä–æ–≤–µ–Ω—å 1)</option>
                        <option value="25">25% (–£—Ä–æ–≤–µ–Ω—å 2)</option>
                        <option value="30">30% (–£—Ä–æ–≤–µ–Ω—å 3)</option>
                        <option value="50">50%</option>
                        <option value="100">100% (–ó–∞–∫—Ä—ã—Ç—å)</option>
                    </select>
                </div>
                <div id="sellPreview" style="background: #f0f0f0; padding: 10px; margin: 10px 0; border: 1px solid #d4d4d4;">
                    <!-- Preview -->
                </div>
                <button class="toolbar-btn sell" onclick="executeSell()" style="width: 100%; padding: 10px;">
                    üí∞ –ü–†–û–î–ê–¢–¨
                </button>
            </div>
        </div>
    </div>

    <!-- Modal: Coin Info -->
    <div id="coinInfoModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span>–î–µ—Ç–∞–ª–∏ —Å–∏–≥–Ω–∞–ª–∞: <span id="infoCoinName"></span></span>
                <span class="modal-close" onclick="closeCoinInfoModal()">&times;</span>
            </div>
            <div class="modal-body" id="coinInfoBody">
                <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è -->
            </div>
        </div>
    </div>

    <script>
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∏
        const SETTINGS = {
            deposit: 10000,
            riskPerTrade: 2, // %
            levels: [
                { pct: 50, sell: 20, name: '–£—Ä–æ–≤–µ–Ω—å 1' },
                { pct: 100, sell: 25, name: '–£—Ä–æ–≤–µ–Ω—å 2' },
                { pct: 200, sell: 30, name: '–£—Ä–æ–≤–µ–Ω—å 3' },
                { pct: 400, sell: 25, name: 'Moon' }
            ]
        };

        let portfolio = [];
        let history = [];
        let autoUpdateInterval = null;
        let currentSellIndex = null;

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        window.onload = function() {
            loadData();
            renderTable();
            updateSummary();
        };

        function loadData() {
            // –î–∞–Ω–Ω—ã–µ –∏–∑ Bybit (52 –ø–æ–∑–∏—Ü–∏–∏)
            const BYBIT_DATA = [
                {
                                "symbol": "PIPPIN",
                                "source": "Bybit",
                                "score": "",
                                "entryDate": "2024-12-29",
                                "reason": "Bybit Futures",
                                "entry": 0.0777,
                                "quantity": 41.0,
                                "stop": 0.04662,
                                "current": 0.42756,
                                "notes": "Leverage: 10x | P&L: +816.9% | Imported: 29.12.2024"
                },
                {
                                "symbol": "ICNT",
                                "source": "Bybit",
                                "score": "",
                                "entryDate": "2024-12-29",
                                "reason": "Bybit Futures",
                                "entry": 0.3754,
                                "quantity": 26.0,
                                "stop": 0.4083,
                                "current": 0.5319,
                                "notes": "Leverage: 10x | P&L: +292.4% | Imported: 29.12.2024"
                },
                {
                                "symbol": "LYN",
                                "source": "Bybit",
                                "score": "",
                                "entryDate": "2024-12-29",
                                "reason": "Bybit Futures",
                                "entry": 0.12106,
                                "quantity": 82.0,
                                "stop": 0.072636,
                                "current": 0.16801,
                                "notes": "Leverage: 10x | P&L: +277.6% | Imported: 29.12.2024"
                },
                {
                                "symbol": "PIEVERSE",
                                "source": "Bybit",
                                "score": "",
                                "entryDate": "2024-12-29",
                                "reason": "Bybit Futures",
                                "entry": 0.454,
                                "quantity": 26.0,
                                "stop": 0.2724,
                                "current": 0.55783,
                                "notes": "Leverage: 10x | P&L: +184.6% | Imported: 29.12.2024"
                },
                {
                                "symbol": "SQD",
                                "source": "Bybit",
                                "score": "",
                                "entryDate": "2024-12-29",
                                "reason": "Bybit Futures",
                                "entry": 0.08699,
                                "quantity": 114.0,
                                "stop": 0.052194,
                                "current": 0.09595,
                                "notes": "Leverage: 10x | P&L: +92.6% | Imported: 29.12.2024"
                },
                {
                                "symbol": "PARTI",
                                "source": "Bybit",
                                "score": "",
                                "entryDate": "2024-12-29",
                                "reason": "Bybit Futures",
                                "entry": 0.09764,
                                "quantity": 116.0,
                                "stop": 0.058584,
                                "current": 0.10534,
                                "notes": "Leverage: 10x | P&L: +72.5% | Imported: 29.12.2024"
                },
                {
                                "symbol": "ESPORTS",
                                "source": "Bybit",
                                "score": "",
                                "entryDate": "2024-12-29",
                                "reason": "Bybit Futures",
                                "entry": 0.39183,
                                "quantity": 12.0,
                                "stop": 0.235098,
                                "current": 0.43635,
                                "notes": "Leverage: 10x | P&L: +101.1% | Imported: 29.12.2024"
                },
                {
                                "symbol": "BEAT",
                                "source": "Bybit",
                                "score": "",
                                "entryDate": "2024-12-29",
                                "reason": "Bybit Futures",
                                "entry": 2.5332,
                                "quantity": 1.0,
                                "stop": 1.51992,
                                "current": 3.0312,
                                "notes": "Leverage: 10x | P&L: +162.9% | Imported: 29.12.2024"
                },
                {
                                "symbol": "KITE",
                                "source": "Bybit",
                                "score": "",
                                "entryDate": "2024-12-29",
                                "reason": "Bybit Futures",
                                "entry": 0.08894,
                                "quantity": 112.0,
                                "stop": 0.08574,
                                "current": 0.09153,
                                "notes": "Leverage: 10x | P&L: +28.1% | Imported: 29.12.2024"
                },
                {
                                "symbol": "MYX",
                                "source": "Bybit",
                                "score": "",
                                "entryDate": "2024-12-29",
                                "reason": "Bybit Futures",
                                "entry": 3.4461,
                                "quantity": 3.0,
                                "stop": 2.06766,
                                "current": 3.5161,
                                "notes": "Leverage: 10x | P&L: +19.7% | Imported: 29.12.2024"
                },
                {
                                "symbol": "GMT",
                                "source": "Bybit",
                                "score": "",
                                "entryDate": "2024-12-29",
                                "reason": "Bybit Futures",
                                "entry": 0.01719,
                                "quantity": 290.0,
                                "stop": 0.010314,
                                "current": 0.01715,
                                "notes": "Leverage: 10x | P&L: -2.3% | Imported: 29.12.2024"
                },
                {
                                "symbol": "STBL",
                                "source": "Bybit",
                                "score": "",
                                "entryDate": "2024-12-29",
                                "reason": "Bybit Futures",
                                "entry": 0.05824,
                                "quantity": 115.0,
                                "stop": 0.034944,
                                "current": 0.05755,
                                "notes": "Leverage: 10x | P&L: -11.9% | Imported: 29.12.2024"
                },
                {
                                "symbol": "VVV",
                                "source": "Bybit",
                                "score": "",
                                "entryDate": "2024-12-29",
                                "reason": "Bybit Futures",
                                "entry": 1.6847,
                                "quantity": 4.0,
                                "stop": 1.01082,
                                "current": 1.6597,
                                "notes": "Leverage: 10x | P&L: -14.9% | Imported: 29.12.2024"
                },
                {
                                "symbol": "BCH",
                                "source": "Bybit",
                                "score": "",
                                "entryDate": "2024-12-29",
                                "reason": "Bybit Futures",
                                "entry": 610.5,
                                "quantity": 0.02,
                                "stop": 366.3,
                                "current": 603.6,
                                "notes": "Leverage: 10x | P&L: -11.3% | Imported: 29.12.2024"
                },
                {
                                "symbol": "FARTCOIN",
                                "source": "Bybit",
                                "score": "",
                                "entryDate": "2024-12-29",
                                "reason": "Bybit Futures",
                                "entry": 0.2719,
                                "quantity": 18.3,
                                "stop": 0.2144,
                                "current": 0.2938,
                                "notes": "Leverage: 10x | P&L: -29.7% | Imported: 29.12.2024"
                },
                {
                                "symbol": "SAPIEN",
                                "source": "Bybit",
                                "score": "",
                                "entryDate": "2024-12-29",
                                "reason": "Bybit Futures",
                                "entry": 0.12404,
                                "quantity": 75.0,
                                "stop": 0.074424,
                                "current": 0.12117,
                                "notes": "Leverage: 10x | P&L: -23.4% | Imported: 29.12.2024"
                },
                {
                                "symbol": "CFX",
                                "source": "Bybit",
                                "score": "",
                                "entryDate": "2024-12-29",
                                "reason": "Bybit Futures",
                                "entry": 0.07465,
                                "quantity": 133.0,
                                "stop": 0.04479,
                                "current": 0.07087,
                                "notes": "Leverage: 10x | P&L: -52.8% | Imported: 29.12.2024"
                },
                {
                                "symbol": "T",
                                "source": "Bybit",
                                "score": "",
                                "entryDate": "2024-12-29",
                                "reason": "Bybit Futures",
                                "entry": 0.010044,
                                "quantity": 490.0,
                                "stop": 0.008453,
                                "current": 0.008936,
                                "notes": "Leverage: 10x | P&L: -122.8% | Imported: 29.12.2024"
                },
                {
                                "symbol": "MEW",
                                "source": "Bybit",
                                "score": "",
                                "entryDate": "2024-12-29",
                                "reason": "Bybit Futures",
                                "entry": 0.0009124,
                                "quantity": 10900.0,
                                "stop": 0.0008335,
                                "current": 0.000848,
                                "notes": "Leverage: 10x | P&L: -75.2% | Imported: 29.12.2024"
                },
                {
                                "symbol": "KAS",
                                "source": "Bybit",
                                "score": "",
                                "entryDate": "2024-12-29",
                                "reason": "Bybit Futures",
                                "entry": 0.05289,
                                "quantity": 90.0,
                                "stop": 0.031734,
                                "current": 0.04394,
                                "notes": "Leverage: 10x | P&L: -201.5% | Imported: 29.12.2024"
                },
                {
                                "symbol": "NTRN",
                                "source": "Bybit",
                                "score": "",
                                "entryDate": "2024-12-29",
                                "reason": "Bybit Futures",
                                "entry": 0.03008,
                                "quantity": 332.0,
                                "stop": 0.018048,
                                "current": 0.02762,
                                "notes": "Leverage: 10x | P&L: -44.3% | Imported: 29.12.2024"
                },
                {
                                "symbol": "EVAA",
                                "source": "Bybit",
                                "score": "",
                                "entryDate": "2024-12-29",
                                "reason": "Bybit Futures",
                                "entry": 0.9943,
                                "quantity": 10.0,
                                "stop": 0.59658,
                                "current": 0.9091,
                                "notes": "Leverage: 10x | P&L: -92.7% | Imported: 29.12.2024"
                },
                {
                                "symbol": "ETH",
                                "source": "Bybit",
                                "score": "",
                                "entryDate": "2024-12-29",
                                "reason": "Bybit Futures",
                                "entry": 3029.2,
                                "quantity": 0.01,
                                "stop": 1817.52,
                                "current": 2932.11,
                                "notes": "Leverage: 10x | P&L: -32.8% | Imported: 29.12.2024"
                },
                {
                                "symbol": "SOLV",
                                "source": "Bybit",
                                "score": "",
                                "entryDate": "2024-12-29",
                                "reason": "Bybit Futures",
                                "entry": 0.01645,
                                "quantity": 615.0,
                                "stop": 0.00987,
                                "current": 0.01451,
                                "notes": "Leverage: 10x | P&L: -132.3% | Imported: 29.12.2024"
                },
                {
                                "symbol": "CTC",
                                "source": "Bybit",
                                "score": "",
                                "entryDate": "2024-12-29",
                                "reason": "Bybit Futures",
                                "entry": 0.3274,
                                "quantity": 15.0,
                                "stop": 0.19644,
                                "current": 0.24774,
                                "notes": "Leverage: 10x | P&L: -317.8% | Imported: 29.12.2024"
                },
                {
                                "symbol": "INIT",
                                "source": "Bybit",
                                "score": "",
                                "entryDate": "2024-12-29",
                                "reason": "Bybit Futures",
                                "entry": 0.10112,
                                "quantity": 98.0,
                                "stop": 0.060672,
                                "current": 0.08641,
                                "notes": "Leverage: 10x | P&L: -168.5% | Imported: 29.12.2024"
                },
                {
                                "symbol": "XNO",
                                "source": "Bybit",
                                "score": "",
                                "entryDate": "2024-12-29",
                                "reason": "Bybit Futures",
                                "entry": 0.9432,
                                "quantity": 8.0,
                                "stop": 0.56592,
                                "current": 0.7075,
                                "notes": "Leverage: 10x | P&L: -165.7% | Imported: 29.12.2024"
                },
                {
                                "symbol": "ORCA",
                                "source": "Bybit",
                                "score": "",
                                "entryDate": "2024-12-29",
                                "reason": "Bybit Futures",
                                "entry": 1.4437,
                                "quantity": 5.6,
                                "stop": 0.86622,
                                "current": 1.1058,
                                "notes": "Leverage: 10x | P&L: -302.0% | Imported: 29.12.2024"
                },
                {
                                "symbol": "COAI",
                                "source": "Bybit",
                                "score": "",
                                "entryDate": "2024-12-29",
                                "reason": "Bybit Futures",
                                "entry": 0.6694,
                                "quantity": 7.0,
                                "stop": 0.40164,
                                "current": 0.3917,
                                "notes": "Leverage: 10x | P&L: -697.2% | Imported: 29.12.2024"
                },
                {
                                "symbol": "KAITO",
                                "source": "Bybit",
                                "score": "",
                                "entryDate": "2024-12-29",
                                "reason": "Bybit Futures",
                                "entry": 0.7376,
                                "quantity": 10.0,
                                "stop": 0.44256,
                                "current": 0.5302,
                                "notes": "Leverage: 10x | P&L: -386.3% | Imported: 29.12.2024"
                },
                {
                                "symbol": "SOLAYER",
                                "source": "Bybit",
                                "score": "",
                                "entryDate": "2024-12-29",
                                "reason": "Bybit Futures",
                                "entry": 0.2983,
                                "quantity": 21.0,
                                "stop": 0.17898,
                                "current": 0.171,
                                "notes": "Leverage: 10x | P&L: -732.9% | Imported: 29.12.2024"
                },
                {
                                "symbol": "GUN",
                                "source": "Bybit",
                                "score": "",
                                "entryDate": "2024-12-29",
                                "reason": "Bybit Futures",
                                "entry": 0.01535,
                                "quantity": 651.0,
                                "stop": 0.00921,
                                "current": 0.011022,
                                "notes": "Leverage: 10x | P&L: -387.8% | Imported: 29.12.2024"
                },
                {
                                "symbol": "LIGHT",
                                "source": "Bybit",
                                "score": "",
                                "entryDate": "2024-12-29",
                                "reason": "Bybit Futures",
                                "entry": 0.7814,
                                "quantity": 12.0,
                                "stop": 0.46884,
                                "current": 0.5215,
                                "notes": "Leverage: 10x | P&L: -491.1% | Imported: 29.12.2024"
                },
                {
                                "symbol": "ARC",
                                "source": "Bybit",
                                "score": "",
                                "entryDate": "2024-12-29",
                                "reason": "Bybit Futures",
                                "entry": 0.05327,
                                "quantity": 187.0,
                                "stop": 0.031962,
                                "current": 0.03658,
                                "notes": "Leverage: 10x | P&L: -450.4% | Imported: 29.12.2024"
                },
                {
                                "symbol": "UNI",
                                "source": "Bybit",
                                "score": "",
                                "entryDate": "2024-12-29",
                                "reason": "Bybit Futures",
                                "entry": 7.081,
                                "quantity": 3.0,
                                "stop": 4.2486,
                                "current": 6.028,
                                "notes": "Leverage: 10x | P&L: -172.9% | Imported: 29.12.2024"
                },
                {
                                "symbol": "ZEN",
                                "source": "Bybit",
                                "score": "",
                                "entryDate": "2024-12-29",
                                "reason": "Bybit Futures",
                                "entry": 15.449,
                                "quantity": 0.6,
                                "stop": 9.2694,
                                "current": 9.048,
                                "notes": "Leverage: 10x | P&L: -696.7% | Imported: 29.12.2024"
                },
                {
                                "symbol": "BANK",
                                "source": "Bybit",
                                "score": "",
                                "entryDate": "2024-12-29",
                                "reason": "Bybit Futures",
                                "entry": 0.07115,
                                "quantity": 180.0,
                                "stop": 0.04269,
                                "current": 0.04968,
                                "notes": "Leverage: 10x | P&L: -426.2% | Imported: 29.12.2024"
                },
                {
                                "symbol": "KERNEL",
                                "source": "Bybit",
                                "score": "",
                                "entryDate": "2024-12-29",
                                "reason": "Bybit Futures",
                                "entry": 0.11832,
                                "quantity": 84.0,
                                "stop": 0.070992,
                                "current": 0.0715,
                                "notes": "Leverage: 10x | P&L: -645.2% | Imported: 29.12.2024"
                },
                {
                                "symbol": "F",
                                "source": "Bybit",
                                "score": "",
                                "entryDate": "2024-12-29",
                                "reason": "Bybit Futures",
                                "entry": 0.012113,
                                "quantity": 825.0,
                                "stop": 0.0072678,
                                "current": 0.007249,
                                "notes": "Leverage: 10x | P&L: -661.0% | Imported: 29.12.2024"
                },
                {
                                "symbol": "RAYDIUM",
                                "source": "Bybit",
                                "score": "",
                                "entryDate": "2024-12-29",
                                "reason": "Bybit Futures",
                                "entry": 1.5604,
                                "quantity": 6.4,
                                "stop": 0.93624,
                                "current": 0.9229,
                                "notes": "Leverage: 10x | P&L: -680.4% | Imported: 29.12.2024"
                },
                {
                                "symbol": "BANANAS31",
                                "source": "Bybit",
                                "score": "",
                                "entryDate": "2024-12-29",
                                "reason": "Bybit Futures",
                                "entry": 0.005887,
                                "quantity": 1700.0,
                                "stop": 0.0035322,
                                "current": 0.003471,
                                "notes": "Leverage: 10x | P&L: -685.6% | Imported: 29.12.2024"
                },
                {
                                "symbol": "BTR",
                                "source": "Bybit",
                                "score": "",
                                "entryDate": "2024-12-29",
                                "reason": "Bybit Futures",
                                "entry": 0.0466,
                                "quantity": 320.0,
                                "stop": 0.02796,
                                "current": 0.0332,
                                "notes": "Leverage: 10x | P&L: -200.5% | Imported: 29.12.2024"
                },
                {
                                "symbol": "LA",
                                "source": "Bybit",
                                "score": "",
                                "entryDate": "2024-12-29",
                                "reason": "Bybit Futures",
                                "entry": 0.5171,
                                "quantity": 19.3,
                                "stop": 0.31026,
                                "current": 0.2892,
                                "notes": "Leverage: 10x | P&L: -775.6% | Imported: 29.12.2024"
                },
                {
                                "symbol": "GPS",
                                "source": "Bybit",
                                "score": "",
                                "entryDate": "2024-12-29",
                                "reason": "Bybit Futures",
                                "entry": 0.008581,
                                "quantity": 1169.0,
                                "stop": 0.0051486,
                                "current": 0.004797,
                                "notes": "Leverage: 10x | P&L: -775.1% | Imported: 29.12.2024"
                },
                {
                                "symbol": "RESOLV",
                                "source": "Bybit",
                                "score": "",
                                "entryDate": "2024-12-29",
                                "reason": "Bybit Futures",
                                "entry": 0.13138,
                                "quantity": 84.0,
                                "stop": 0.078828,
                                "current": 0.07385,
                                "notes": "Leverage: 10x | P&L: -766.7% | Imported: 29.12.2024"
                },
                {
                                "symbol": "XAN",
                                "source": "Bybit",
                                "score": "",
                                "entryDate": "2024-12-29",
                                "reason": "Bybit Futures",
                                "entry": 0.03206,
                                "quantity": 310.0,
                                "stop": 0.019236,
                                "current": 0.01647,
                                "notes": "Leverage: 10x | P&L: -930.3% | Imported: 29.12.2024"
                },
                {
                                "symbol": "CLANKER",
                                "source": "Bybit",
                                "score": "",
                                "entryDate": "2024-12-29",
                                "reason": "Bybit Futures",
                                "entry": 75.8,
                                "quantity": 0.13,
                                "stop": 45.48,
                                "current": 29.8,
                                "notes": "Leverage: 10x | P&L: -1505.8% | Imported: 29.12.2024"
                },
                {
                                "symbol": "APR",
                                "source": "Bybit",
                                "score": "",
                                "entryDate": "2024-12-29",
                                "reason": "Bybit Futures",
                                "entry": 0.26898,
                                "quantity": 48.0,
                                "stop": 0.161388,
                                "current": 0.13243,
                                "notes": "Leverage: 10x | P&L: -1010.8% | Imported: 29.12.2024"
                },
                {
                                "symbol": "HEMI",
                                "source": "Bybit",
                                "score": "",
                                "entryDate": "2024-12-29",
                                "reason": "Bybit Futures",
                                "entry": 0.02819,
                                "quantity": 512.0,
                                "stop": 0.016914,
                                "current": 0.01534,
                                "notes": "Leverage: 10x | P&L: -822.7% | Imported: 29.12.2024"
                },
                {
                                "symbol": "TA",
                                "source": "Bybit",
                                "score": "",
                                "entryDate": "2024-12-29",
                                "reason": "Bybit Futures",
                                "entry": 0.04214,
                                "quantity": 350.0,
                                "stop": 0.025284,
                                "current": 0.0232,
                                "notes": "Leverage: 10x | P&L: -404.9% | Imported: 29.12.2024"
                },
                {
                                "symbol": "TNSR",
                                "source": "Bybit",
                                "score": "",
                                "entryDate": "2024-12-29",
                                "reason": "Bybit Futures",
                                "entry": 0.24453,
                                "quantity": 40.8,
                                "stop": 0.146718,
                                "current": 0.07991,
                                "notes": "Leverage: 10x | P&L: -2004.8% | Imported: 29.12.2024"
                },
                {
                                "symbol": "TRUTH",
                                "source": "Bybit",
                                "score": "",
                                "entryDate": "2024-12-29",
                                "reason": "Bybit Futures",
                                "entry": 0.018187,
                                "quantity": 1360.0,
                                "stop": 0.0109122,
                                "current": 0.010264,
                                "notes": "Leverage: 10x | P&L: -759.8% | Imported: 29.12.2024"
                }
			];
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–ª–∞–≥ –ø–µ—Ä–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–∏
            const bybitLoaded = localStorage.getItem('bybitDataLoaded_v1');
            
            if (!bybitLoaded) {
                // –ü–ï–†–í–ê–Ø –ó–ê–ì–†–£–ó–ö–ê - –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ Bybit
                console.log('üöÄ –ó–∞–≥—Ä—É–∂–∞–µ–º 52 –ø–æ–∑–∏—Ü–∏–∏ –∏–∑ Bybit...');
                portfolio = BYBIT_DATA;
                history = [];
                savePortfolio();
                localStorage.setItem('bybitDataLoaded_v1', 'true');
                console.log('‚úÖ –î–∞–Ω–Ω—ã–µ Bybit –∑–∞–≥—Ä—É–∂–µ–Ω—ã!');
            } else {
                // –ü–û–°–õ–ï–î–£–Æ–©–ò–ï –ó–ê–ì–†–£–ó–ö–ò - –∏–∑ localStorage
                const saved = localStorage.getItem('portfolioExcel');
                if (saved) {
                    const data = JSON.parse(saved);
                    portfolio = data.portfolio || [];
                    history = data.history || [];
                    console.log(`üìä –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${portfolio.length} –ø–æ–∑–∏—Ü–∏–π`);
                } else {
                    portfolio = BYBIT_DATA;
                    history = [];
                }
            }
        }

        function savePortfolio() {
            localStorage.setItem('portfolioExcel', JSON.stringify({
                portfolio: portfolio,
                history: history
            }));
            showStatus('üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
        }

        function showStatus(msg) {
            const status = document.getElementById('updateStatus');
            const original = status.textContent;
            status.textContent = msg;
            status.style.color = '#32CD32';
            setTimeout(() => {
                status.textContent = original;
                status.style.color = '';
            }, 2000);
        }

        // –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Ç–∞–±–ª–∏—Ü—ã
        function renderTable() {
            const tbody = document.getElementById('portfolioBody');
            tbody.innerHTML = '';

            portfolio.forEach((coin, idx) => {
                const invested = coin.entry * coin.quantity;
                const currentVal = coin.current * coin.quantity;
                const pnlPct = coin.current > 0 ? ((coin.current - coin.entry) / coin.entry) * 100 : 0;
                const pnlUsd = currentVal - invested;
                const riskPct = (invested / SETTINGS.deposit) * 100;

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="row-number">${idx + 1}</td>
                    <td><input type="text" class="editable input-cell" value="${coin.symbol}" onchange="updateCoin(${idx}, 'symbol', this.value.toUpperCase())" style="text-transform: uppercase;"></td>
                    <td>
                        <select class="editable input-cell" onchange="updateCoin(${idx}, 'source', this.value)" style="width: 100%; padding: 3px 2px; text-align: left; cursor: pointer;">
                            <option value="CoinGlass" ${coin.source === 'CoinGlass' ? 'selected' : ''}>CoinGlass</option>
                            <option value="TradingView" ${coin.source === 'TradingView' ? 'selected' : ''}>TradingView</option>
                            <option value="WatchList" ${coin.source === 'WatchList' ? 'selected' : ''}>WatchList</option>
                            <option value="Manual" ${coin.source === 'Manual' ? 'selected' : ''}>Manual</option>
                            <option value="Telegram" ${coin.source === 'Telegram' ? 'selected' : ''}>Telegram</option>
                        </select>
                    </td>
                    <td><input type="text" class="editable input-cell" value="${coin.score || ''}" onchange="updateCoin(${idx}, 'score', this.value)" style="text-align: center;"></td>
                    <td><input type="date" class="editable input-cell" value="${coin.entryDate || ''}" onchange="updateCoin(${idx}, 'entryDate', this.value)" style="font-size: 10px; cursor: pointer;"></td>
                    <td><input type="number" class="editable input-cell" value="${coin.entry}" step="0.0001" onchange="updateCoin(${idx}, 'entry', this.value)" style="text-align: right;"></td>
                    <td><input type="number" class="editable input-cell" value="${coin.quantity}" step="1" onchange="updateCoin(${idx}, 'quantity', this.value)" style="text-align: right;"></td>
                    <td class="formula-cell" style="text-align: right;">$${invested.toFixed(2)}</td>
                    <td class="external-cell" style="text-align: right;">${coin.current > 0 ? '$' + coin.current.toFixed(4) : '‚Äî'}</td>
                    <td class="formula-cell" style="text-align: right;">$${currentVal.toFixed(2)}</td>
                    <td class="${pnlPct >= 0 ? 'cf-positive' : 'cf-negative'}" style="text-align: right; font-weight: bold;">${pnlPct >= 0 ? '+' : ''}${pnlPct.toFixed(1)}%</td>
                    <td class="${pnlUsd >= 0 ? 'cf-positive' : 'cf-negative'}" style="text-align: right; font-weight: bold;">${pnlUsd >= 0 ? '+' : ''}$${pnlUsd.toFixed(2)}</td>
                    <td><input type="number" class="editable input-cell" value="${coin.stop}" step="0.0001" onchange="updateCoin(${idx}, 'stop', this.value)" style="text-align: right;"></td>
                    <td class="formula-cell" style="text-align: right;">${riskPct.toFixed(1)}%</td>
                    <td>${renderLevelProgress(coin, pnlPct)}</td>
                    <td>${renderActions(idx, coin, pnlPct)}</td>
                    <td><button class="cell-btn" onclick="showCoinInfo(${idx})" title="–î–µ—Ç–∞–ª–∏ —Å–∏–≥–Ω–∞–ª–∞">‚ÑπÔ∏è</button></td>
                    <td><button class="cell-btn" onclick="deleteCoin(${idx})" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button></td>
                `;
                tbody.appendChild(row);
            });

            // –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞
            addTotalRow(tbody);
            
            document.getElementById('coinCount').textContent = portfolio.length;
        }

        function renderLevelProgress(coin, pnlPct) {
            let html = '<div class="level-indicators">';
            
            SETTINGS.levels.forEach((level, idx) => {
                let className = 'level-dot';
                if (pnlPct >= level.pct) className += ' active';
                else if (pnlPct >= level.pct * 0.8) className += ' warning';
                html += `<div class="${className}" title="${level.name}: +${level.pct}%"></div>`;
            });
            
            html += '</div>';

            // –ü—Ä–æ–≥—Ä–µ—Å—Å –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ —É—Ä–æ–≤–Ω—è
            let nextLevel = SETTINGS.levels.find(l => pnlPct < l.pct);
            if (nextLevel && coin.current > 0) {
                const progress = Math.min(100, (pnlPct / nextLevel.pct) * 100);
                const levelClass = nextLevel.pct === 50 ? 'level-1' : 
                                 nextLevel.pct === 100 ? 'level-2' :
                                 nextLevel.pct === 200 ? 'level-3' : 'level-moon';
                html += `<div class="level-progress"><div class="level-progress-bar ${levelClass}" style="width: ${progress}%"></div></div>`;
                html += `<div style="font-size: 9px; color: #666; margin-top: 2px;">${nextLevel.name}: ${(nextLevel.pct - pnlPct).toFixed(1)}%</div>`;
            }

            return html;
        }

        function renderActions(idx, coin, pnlPct) {
            if (coin.current <= coin.stop && coin.current > 0) {
                return `<button class="cell-btn close" onclick="showSellModal(${idx})">‚õî –°–¢–û–ü</button>`;
            }

            const level = SETTINGS.levels.find(l => pnlPct >= l.pct && pnlPct < (SETTINGS.levels.find(ll => ll.pct > l.pct)?.pct || Infinity));
            
            if (level) {
                return `<button class="cell-btn sell" onclick="showSellModal(${idx})">üí∞ ${level.sell}%</button>`;
            }

            return `<button class="cell-btn" onclick="showSellModal(${idx})">üí∞ –ü—Ä–æ–¥–∞—Ç—å</button>`;
        }

        function addTotalRow(tbody) {
            let totalInvested = 0;
            let totalCurrent = 0;

            portfolio.forEach(coin => {
                totalInvested += coin.entry * coin.quantity;
                totalCurrent += coin.current * coin.quantity;
            });

            const totalPnl = totalCurrent - totalInvested;
            const totalPnlPct = totalInvested > 0 ? (totalPnl / totalInvested) * 100 : 0;

            const row = document.createElement('tr');
            row.className = 'total-row';
            row.innerHTML = `
                <td class="row-number"></td>
                <td colspan="6" style="text-align: right; font-weight: bold;">–ò–¢–û–ì–û:</td>
                <td style="text-align: right;">$${totalInvested.toFixed(2)}</td>
                <td></td>
                <td style="text-align: right;">$${totalCurrent.toFixed(2)}</td>
                <td class="${totalPnlPct >= 0 ? 'cf-positive' : 'cf-negative'}" style="text-align: right;">${totalPnlPct >= 0 ? '+' : ''}${totalPnlPct.toFixed(1)}%</td>
                <td class="${totalPnl >= 0 ? 'cf-positive' : 'cf-negative'}" style="text-align: right;">${totalPnl >= 0 ? '+' : ''}$${totalPnl.toFixed(2)}</td>
                <td colspan="6"></td>
            `;
            tbody.appendChild(row);
        }

        function updateCoin(idx, field, value) {
            if (field === 'symbol' || field === 'source' || field === 'score' || field === 'entryDate' || field === 'reason' || field === 'notes') {
                portfolio[idx][field] = value;
            } else {
                portfolio[idx][field] = parseFloat(value) || 0;
            }
            savePortfolio();
            renderTable();
            updateSummary();
        }

        function addNewRow() {
            portfolio.push({
                symbol: 'NEW',
                source: 'Manual',
                score: '',
                entryDate: new Date().toISOString().split('T')[0],
                reason: '',
                entry: 0,
                quantity: 0,
                stop: 0,
                current: 0,
                notes: ''
            });
            renderTable();
            savePortfolio();
        }

        function showCoinInfo(idx) {
            console.log('showCoinInfo –≤—ã–∑–≤–∞–Ω–∞ –¥–ª—è –∏–Ω–¥–µ–∫—Å–∞:', idx);
            const coin = portfolio[idx];
            console.log('–î–∞–Ω–Ω—ã–µ –º–æ–Ω–µ—Ç—ã:', coin);
            
            if (!coin) {
                console.error('–ú–æ–Ω–µ—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!');
                return;
            }
            
            const pos = calculatePosition(coin);
            
            document.getElementById('infoCoinName').textContent = coin.symbol;
            
            const daysHeld = coin.entryDate ? Math.floor((new Date() - new Date(coin.entryDate)) / (1000 * 60 * 60 * 24)) : 0;
            
            document.getElementById('coinInfoBody').innerHTML = `
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h4 style="margin-bottom: 10px;">üìä –î–∞–Ω–Ω—ã–µ –≤—Ö–æ–¥–∞</h4>
                    <table style="width: 100%; font-size: 12px; border-collapse: collapse;">
                        <tr style="border-bottom: 1px solid #e9ecef;"><td style="padding: 5px;"><strong>–ò—Å—Ç–æ—á–Ω–∏–∫ —Å–∏–≥–Ω–∞–ª–∞:</strong></td><td style="padding: 5px;">${coin.source || '‚Äî'}</td></tr>
                        <tr style="border-bottom: 1px solid #e9ecef;"><td style="padding: 5px;"><strong>Score:</strong></td><td style="padding: 5px;">${coin.score || '‚Äî'}</td></tr>
                        <tr style="border-bottom: 1px solid #e9ecef;"><td style="padding: 5px;"><strong>–î–∞—Ç–∞ –≤—Ö–æ–¥–∞:</strong></td><td style="padding: 5px;">${coin.entryDate ? new Date(coin.entryDate).toLocaleDateString('ru-RU') : '‚Äî'}</td></tr>
                        <tr style="border-bottom: 1px solid #e9ecef;"><td style="padding: 5px;"><strong>–î–Ω–µ–π –≤ –ø–æ–∑–∏—Ü–∏–∏:</strong></td><td style="padding: 5px;">${daysHeld} ${daysHeld === 1 ? '–¥–µ–Ω—å' : daysHeld < 5 ? '–¥–Ω—è' : '–¥–Ω–µ–π'}</td></tr>
                        <tr><td style="padding: 5px;"><strong>–ü—Ä–∏—á–∏–Ω–∞ –≤—Ö–æ–¥–∞:</strong></td><td style="padding: 5px;">${coin.reason || '‚Äî'}</td></tr>
                    </table>
                </div>

                <div style="background: #e7f3ff; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h4 style="margin-bottom: 10px;">üí∞ –¢–µ–∫—É—â–∞—è –ø–æ–∑–∏—Ü–∏—è</h4>
                    <table style="width: 100%; font-size: 12px; border-collapse: collapse;">
                        <tr style="border-bottom: 1px solid #d4e9ff;"><td style="padding: 5px;"><strong>–¶–µ–Ω–∞ –≤—Ö–æ–¥–∞:</strong></td><td style="padding: 5px;">$${coin.entry.toFixed(4)}</td></tr>
                        <tr style="border-bottom: 1px solid #d4e9ff;"><td style="padding: 5px;"><strong>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</strong></td><td style="padding: 5px;">${coin.quantity.toLocaleString()}</td></tr>
                        <tr style="border-bottom: 1px solid #d4e9ff;"><td style="padding: 5px;"><strong>–í–ª–æ–∂–µ–Ω–æ:</strong></td><td style="padding: 5px;">$${pos.totalInvested.toFixed(2)}</td></tr>
                        <tr style="border-bottom: 1px solid #d4e9ff;"><td style="padding: 5px;"><strong>–¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞:</strong></td><td style="padding: 5px;">${coin.current > 0 ? '$' + coin.current.toFixed(4) : '‚Äî'}</td></tr>
                        <tr style="border-bottom: 1px solid #d4e9ff;"><td style="padding: 5px;"><strong>–°—Ç–æ–∏–º–æ—Å—Ç—å:</strong></td><td style="padding: 5px;">$${pos.currentValue.toFixed(2)}</td></tr>
                        <tr><td style="padding: 5px;"><strong>P&L:</strong></td><td style="padding: 5px; color: ${pos.pnlUsd >= 0 ? '#008000' : '#FF0000'}; font-weight: bold;">${pos.pnlUsd >= 0 ? '+' : ''}$${pos.pnlUsd.toFixed(2)} (${pos.pnlPct >= 0 ? '+' : ''}${pos.pnlPct.toFixed(1)}%)</td></tr>
                    </table>
                </div>

                <div style="background: #fff3cd; padding: 15px; border-radius: 8px;">
                    <h4 style="margin-bottom: 10px;">‚ö†Ô∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∏—Å–∫–∞–º–∏</h4>
                    <table style="width: 100%; font-size: 12px; border-collapse: collapse;">
                        <tr style="border-bottom: 1px solid #ffe69c;"><td style="padding: 5px;"><strong>–°—Ç–æ–ø-–ª–æ—Å—Å:</strong></td><td style="padding: 5px;">$${coin.stop.toFixed(4)}</td></tr>
                        <tr style="border-bottom: 1px solid #ffe69c;"><td style="padding: 5px;"><strong>–†–∏—Å–∫ –æ—Ç –¥–µ–ø–æ–∑–∏—Ç–∞:</strong></td><td style="padding: 5px;">${((pos.totalInvested / SETTINGS.deposit) * 100).toFixed(1)}%</td></tr>
                        <tr><td style="padding: 5px;"><strong>–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ —Å—Ç–æ–ø–∞:</strong></td><td style="padding: 5px;">${coin.current > 0 ? ((1 - coin.stop / coin.current) * 100).toFixed(1) + '%' : '‚Äî'}</td></tr>
                    </table>
                </div>

                ${coin.notes ? `
                <div style="background: #f0f0f0; padding: 15px; border-radius: 8px; margin-top: 15px;">
                    <h4 style="margin-bottom: 10px;">üìù –ó–∞–º–µ—Ç–∫–∏</h4>
                    <p style="font-size: 12px; white-space: pre-wrap;">${coin.notes}</p>
                </div>
                ` : ''}

                <div style="margin-top: 15px;">
                    <button class="toolbar-btn" onclick="editCoinNotes(${idx})" style="width: 100%; padding: 8px;">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–º–µ—Ç–∫–∏</button>
                </div>
            `;
            
            document.getElementById('coinInfoModal').style.display = 'block';
        }

        function calculatePosition(coin) {
            const totalInvested = coin.entry * coin.quantity;
            const currentValue = coin.current * coin.quantity;
            const pnlPct = coin.current > 0 ? ((coin.current - coin.entry) / coin.entry) * 100 : 0;
            const pnlUsd = currentValue - totalInvested;

            return {
                totalInvested,
                currentValue,
                pnlPct,
                pnlUsd
            };
        }

        function closeCoinInfoModal() {
            document.getElementById('coinInfoModal').style.display = 'none';
        }

        function editCoinNotes(idx) {
            const coin = portfolio[idx];
            const newNotes = prompt('–ó–∞–º–µ—Ç–∫–∏:', coin.notes || '');
            if (newNotes !== null) {
                coin.notes = newNotes;
                savePortfolio();
                showCoinInfo(idx); // –û–±–Ω–æ–≤–∏—Ç—å –æ–∫–Ω–æ
            }
        }

        function deleteCoin(idx) {
            if (confirm(`–£–¥–∞–ª–∏—Ç—å ${portfolio[idx].symbol}?`)) {
                portfolio.splice(idx, 1);
                renderTable();
                updateSummary();
                savePortfolio();
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ü–µ–Ω
        async function updateAllPrices() {
            showStatus('üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ...');
            
            for (let coin of portfolio) {
                if (coin.symbol === 'NEW') continue;
                const price = await getBybitPrice(coin.symbol);
                if (price > 0) coin.current = price;
                await new Promise(r => setTimeout(r, 300));
            }

            renderTable();
            updateSummary();
            savePortfolio();
            
            const now = new Date().toLocaleString('ru-RU');
            document.getElementById('lastUpdate').textContent = `–û–±–Ω–æ–≤–ª–µ–Ω–æ: ${now}`;
            showStatus('‚úÖ –¶–µ–Ω—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã');
        }

        async function getBybitPrice(symbol) {
            try {
                const ticker = symbol.toUpperCase() + 'USDT';
                const response = await fetch(`https://api.bybit.com/v5/market/tickers?category=linear&symbol=${ticker}`);
                const data = await response.json();
                
                if (data.retCode === 0 && data.result?.list?.length > 0) {
                    return parseFloat(data.result.list[0].lastPrice);
                }
                return 0;
            } catch (e) {
                return 0;
            }
        }

        function toggleAutoUpdate() {
            const checkbox = document.getElementById('autoUpdate');
            const status = document.getElementById('updateStatus');

            if (checkbox.checked) {
                status.textContent = '–ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: –≤–∫–ª (5 –º–∏–Ω)';
                status.style.color = '#32CD32';
                autoUpdateInterval = setInterval(updateAllPrices, 5 * 60 * 1000);
                updateAllPrices();
            } else {
                status.textContent = '–ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: –≤—ã–∫–ª';
                status.style.color = '';
                if (autoUpdateInterval) {
                    clearInterval(autoUpdateInterval);
                }
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–≤–æ–¥–∫–∏
        function updateSummary() {
            let totalInvested = 0;
            let currentValue = 0;
            let portfolioRisk = 0;

            portfolio.forEach(coin => {
                const invested = coin.entry * coin.quantity;
                totalInvested += invested;
                currentValue += coin.current * coin.quantity;
                portfolioRisk += invested;
            });

            const unrealizedPnl = currentValue - totalInvested;
            const realizedPnl = history.reduce((sum, h) => sum + (h.pnl || 0), 0);
            const totalPnl = unrealizedPnl + realizedPnl;
            const roi = totalInvested > 0 ? (totalPnl / totalInvested) * 100 : 0;
            const riskPct = (portfolioRisk / SETTINGS.deposit) * 100;

            document.getElementById('totalDeposit').textContent = '$' + SETTINGS.deposit.toLocaleString();
            document.getElementById('totalInvested').textContent = '$' + totalInvested.toFixed(2);
            document.getElementById('currentValue').textContent = '$' + currentValue.toFixed(2);
            
            const realizedEl = document.getElementById('realizedPnl');
            realizedEl.textContent = (realizedPnl >= 0 ? '+' : '') + '$' + realizedPnl.toFixed(2);
            realizedEl.className = 'summary-value ' + (realizedPnl >= 0 ? 'positive' : 'negative');

            const unrealizedEl = document.getElementById('unrealizedPnl');
            unrealizedEl.textContent = (unrealizedPnl >= 0 ? '+' : '') + '$' + unrealizedPnl.toFixed(2);
            unrealizedEl.className = 'summary-value ' + (unrealizedPnl >= 0 ? 'positive' : 'negative');

            const totalPnlEl = document.getElementById('totalPnl');
            totalPnlEl.textContent = (totalPnl >= 0 ? '+' : '') + '$' + totalPnl.toFixed(2);
            totalPnlEl.className = 'summary-value ' + (totalPnl >= 0 ? 'positive' : 'negative');

            const roiEl = document.getElementById('roi');
            roiEl.textContent = (roi >= 0 ? '+' : '') + roi.toFixed(1) + '%';
            roiEl.className = 'summary-value ' + (roi >= 0 ? 'positive' : 'negative');

            const riskEl = document.getElementById('portfolioRisk');
            riskEl.textContent = riskPct.toFixed(1) + '%';
            riskEl.className = 'summary-value ' + (riskPct > 80 ? 'negative' : riskPct > 50 ? '' : 'positive');

            document.getElementById('avgROI').textContent = roi.toFixed(1) + '%';
        }

        // –ü—Ä–æ–¥–∞–∂–∞
        function showSellModal(idx) {
            currentSellIndex = idx;
            const coin = portfolio[idx];
            
            document.getElementById('sellCoinName').textContent = coin.symbol;
            document.getElementById('sellPrice').value = coin.current.toFixed(4);
            document.getElementById('sellQty').value = '';
            updateSellPreview();
            
            document.getElementById('sellModal').style.display = 'block';
        }

        function closeSellModal() {
            document.getElementById('sellModal').style.display = 'none';
            currentSellIndex = null;
        }

        function quickSell(pct) {
            if (!pct || currentSellIndex === null) return;
            const coin = portfolio[currentSellIndex];
            const qty = Math.floor(coin.quantity * (pct / 100));
            document.getElementById('sellQty').value = qty;
            updateSellPreview();
        }

        function updateSellPreview() {
            if (currentSellIndex === null) return;

            const coin = portfolio[currentSellIndex];
            const price = parseFloat(document.getElementById('sellPrice').value) || 0;
            const qty = parseFloat(document.getElementById('sellQty').value) || 0;

            if (!price || !qty) {
                document.getElementById('sellPreview').innerHTML = '<p>–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ</p>';
                return;
            }

            const amount = price * qty;
            const cost = coin.entry * qty;
            const pnl = amount - cost;
            const pnlPct = (pnl / cost) * 100;

            document.getElementById('sellPreview').innerHTML = `
                <strong>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä:</strong><br>
                –ü—Ä–æ–¥–∞–µ—Ç–µ: ${qty} ${coin.symbol}<br>
                –ü–æ —Ü–µ–Ω–µ: $${price.toFixed(4)}<br>
                –ü–æ–ª—É—á–∏—Ç–µ: $${amount.toFixed(2)}<br>
                –ü—Ä–∏–±—ã–ª—å: <span style="color: ${pnl >= 0 ? '#008000' : '#FF0000'}; font-weight: bold;">${pnl >= 0 ? '+' : ''}$${pnl.toFixed(2)} (${pnlPct >= 0 ? '+' : ''}${pnlPct.toFixed(1)}%)</span><br>
                –û—Å—Ç–∞–Ω–µ—Ç—Å—è: ${coin.quantity - qty} ${coin.symbol}
            `;
        }

        document.getElementById('sellPrice')?.addEventListener('input', updateSellPreview);
        document.getElementById('sellQty')?.addEventListener('input', updateSellPreview);

        function executeSell() {
            if (currentSellIndex === null) return;

            const coin = portfolio[currentSellIndex];
            const price = parseFloat(document.getElementById('sellPrice').value);
            const qty = parseFloat(document.getElementById('sellQty').value);

            if (!price || !qty || qty > coin.quantity) {
                alert('–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∞–Ω–Ω—ã–µ!');
                return;
            }

            const amount = price * qty;
            const cost = coin.entry * qty;
            const pnl = amount - cost;

            // –î–æ–±–∞–≤–ª—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
            history.push({
                date: new Date().toISOString(),
                symbol: coin.symbol,
                type: 'sell',
                price: price,
                quantity: qty,
                amount: amount,
                pnl: pnl
            });

            // –£–º–µ–Ω—å—à–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ
            coin.quantity -= qty;

            // –ï—Å–ª–∏ –ø—Ä–æ–¥–∞–ª–∏ –≤—Å–µ - —É–¥–∞–ª—è–µ–º
            if (coin.quantity <= 0) {
                portfolio.splice(currentSellIndex, 1);
            }

            savePortfolio();
            renderTable();
            updateSummary();
            closeSellModal();

            alert(`‚úÖ –ü—Ä–æ–¥–∞–Ω–æ ${qty} ${coin.symbol}\n–ü—Ä–∏–±—ã–ª—å: ${pnl >= 0 ? '+' : ''}$${pnl.toFixed(2)}`);
        }

        // –≠–∫—Å–ø–æ—Ä—Ç/–ò–º–ø–æ—Ä—Ç
        function exportToJSON() {
            const data = {
                portfolio: portfolio,
                history: history,
                settings: SETTINGS,
                date: new Date().toISOString()
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'portfolio_' + new Date().toISOString().split('T')[0] + '.json';
            a.click();
        }

        function importFromJSON() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const data = JSON.parse(event.target.result);
                        portfolio = data.portfolio || [];
                        history = data.history || [];
                        savePortfolio();
                        renderTable();
                        updateSummary();
                        alert('‚úÖ –ò–º–ø–æ—Ä—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω');
                    } catch (err) {
                        alert('‚ùå –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function showHistory() {
            if (history.length === 0) {
                alert('–ò—Å—Ç–æ—Ä–∏—è —Å–¥–µ–ª–æ–∫ –ø—É—Å—Ç–∞');
                return;
            }

            let html = '<h3>–ò—Å—Ç–æ—Ä–∏—è —Å–¥–µ–ª–æ–∫:</h3><table style="width: 100%; font-size: 11px;">';
            html += '<tr><th>–î–∞—Ç–∞</th><th>–ú–æ–Ω–µ—Ç–∞</th><th>–¢–∏–ø</th><th>–¶–µ–Ω–∞</th><th>–ö–æ–ª-–≤–æ</th><th>–°—É–º–º–∞</th><th>P&L</th></tr>';
            
            history.forEach(h => {
                const date = new Date(h.date).toLocaleString('ru-RU');
                const pnlColor = h.pnl >= 0 ? '#008000' : '#FF0000';
                html += `<tr>
                    <td>${date}</td>
                    <td>${h.symbol}</td>
                    <td>${h.type === 'buy' ? 'üü¢ –ü–æ–∫—É–ø–∫–∞' : 'üî¥ –ü—Ä–æ–¥–∞–∂–∞'}</td>
                    <td>$${h.price.toFixed(4)}</td>
                    <td>${h.quantity}</td>
                    <td>$${h.amount.toFixed(2)}</td>
                    <td style="color: ${pnlColor};">${h.pnl ? (h.pnl >= 0 ? '+' : '') + '$' + h.pnl.toFixed(2) : '‚Äî'}</td>
                </tr>`;
            });
            
            html += '</table>';
            
            const win = window.open('', '–ò—Å—Ç–æ—Ä–∏—è', 'width=800,height=600');
            win.document.write(html);
        }

        function showSettings() {
            alert('–ù–∞—Å—Ç—Ä–æ–π–∫–∏:\n\n' +
                  `–î–µ–ø–æ–∑–∏—Ç: $${SETTINGS.deposit}\n` +
                  `–†–∏—Å–∫ –Ω–∞ —Å–¥–µ–ª–∫—É: ${SETTINGS.riskPerTrade}%\n\n` +
                  '–£—Ä–æ–≤–Ω–∏ —Ñ–∏–∫—Å–∞—Ü–∏–∏:\n' +
                  SETTINGS.levels.map(l => `+${l.pct}%: –ø—Ä–æ–¥–∞—Ç—å ${l.sell}%`).join('\n'));
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }
    </script>


      </div>

    </section>
  </main>
</div>

<script src="assets/js/portfolio.js"></script>
</body>
</html>
